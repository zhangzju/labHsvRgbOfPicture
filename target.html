<!DOCTYPE html>
<html>

<head>
    <!--Import materialize.css-->
    <link href="http://cdn.bootcss.com/materialize/0.97.6/css/materialize.css" rel="stylesheet">
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta charset="utf8" />
</head>

<body>
    <div class="container">
        <div class="row">
            <nav>
                <div class="nav-wrapper">
                    <a href="#" class="brand-logo">BearFashion</a>
                    <ul id="nav-mobile" class="right hide-on-med-and-down">
                        <li><a href="badges">标签</a></li>
                        <li><a href="buttons">按钮</a></li>
                        <li><a href="footer">页脚</a></li>
                    </ul>
                </div>
            </nav>
            <div class="col s6">
                <div class="card">
                    <div class="card-image">
                        <img src="0001.jpeg" id="choosen-01" class="choosen">
                        <div class="preview"></div>
                    </div>
                    <div class="card-content">
                        <div class="result">
                            <span>HEX: #22142b</span>
                            <span>RGB: rgb(34,20,43)</span>
                        </div>
                    </div>
                    <canvas id="cs" style="display:none"></canvas>
                </div>
            </div>
            <div class="col s6">
                <div class="card">
                    <div class="card-image">
                        <img src="0001.jpeg" id="showFabric">
                    </div>
                    <div class="card-content">
                        <a class="waves-effect waves-light btn-large" id="control-img">Debug</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--Import jQuery before materialize.js-->
    <script src="http://cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/materialize/0.97.6/js/materialize.min.js"></script>
    <script>
    // vars
    var img = _('#choosen-01'),
        canvas = _('#cs'),
        result = _('.result'),
        preview = _('.preview'),
        button = _('#control-img'),
        x = '',
        y = '';


    var fabricJson = {
        "white": {
            "name": "img/Large_0267082.jpg"
        },
        "black": {
            "name": "img/Large_0260739.jpg"
        },
        "red": {
            "name": "img/Large_0289578.jpg"
        }
    };

    button.addEventListener('click', function(argument) {
        alert(fabricJson.white.name);
    }, false);

    // click function
    img.addEventListener('click', function(e) {
        // chrome
        if (e.offsetX) {
            x = e.offsetX;
            y = e.offsetY;
        }
        // firefox
        else if (e.layerX) {
            x = e.layerX;
            y = e.layerY;
        }
        useCanvas(canvas, img, function() {
            // get image data
            var p = canvas.getContext('2d')
                .getImageData(x, y, 1, 1).data;
            // show info
            result.innerHTML = '<span>HEX: ' + rgbToHex(p[0], p[1], p[2]) + '</span>' +
                '<span>RGB:  rgb(' +
                p[0] + ',' +
                p[1] + ',' +
                p[2] + ')</span>';

            // add background in body
            document.body.style.background = rgbToHex(p[0], p[1], p[2]);
        });
    }, false);

    // preview function mousemove
    img.addEventListener('mousemove', function(e) {
        // chrome
        if (e.offsetX) {
            x = e.offsetX;
            y = e.offsetY;
        }
        // firefox
        else if (e.layerX) {
            x = e.layerX;
            y = e.layerY;
        }

        useCanvas(canvas, img, function() {

            // get image data
            var p = canvas.getContext('2d')
                .getImageData(x, y, 1, 1).data;
            // show preview color
            preview.style.background = rgbToHex(p[0], p[1], p[2]);
            changeFabric(p[0], p[1], p[2])
        });
    }, false);


    // canvas function
    function useCanvas(el, image, callback) {
        el.width = image.width; // img width
        el.height = image.height; // img height
        // draw image in canvas tag
        el.getContext('2d')
            .drawImage(image, 0, 0, image.width, image.height);
        return callback();
    }
    // short querySelector
    function _(el) {
        return document.querySelector(el);
    };

    // convert rgba to hex 
    // http://stackoverflow.com/questions/5623838/rgb-to-hex-and-hex-to-rgb
    function componentToHex(c) {
        var hex = c.toString(16);
        return hex.length == 1 ? "0" + hex : hex;
    }

    function rgbToHex(r, g, b) {
        return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
    }

    function findPos(obj) {
        var curleft = 0,
            curtop = 0;
        if (obj.offsetParent) {
            do {
                curleft += obj.offsetLeft;
                curtop += obj.offsetTop;
            } while (obj = obj.offsetParent);
            return {
                x: curleft,
                y: curtop
            };
        }
        return undefined;
    }

    function changeFabric(r, g, b) {
        if (r >= 200 && g >= 200 && b >= 200) {
            $('#showFabric').attr("src", fabricJson.white.name);
        } else if (r <= 100 && g <= 100 & b <= 100) {
            $('#showFabric').attr("src", fabricJson.black.name);
        } else {
            $('#showFabric').attr("src", fabricJson.red.name);
        }
    }

    function rgb2hsv() {
        var rr, gg, bb,
            r = arguments[0] / 255,
            g = arguments[1] / 255,
            b = arguments[2] / 255,
            h, s,
            v = Math.max(r, g, b),
            diff = v - Math.min(r, g, b),
            diffc = function(c) {
                return (v - c) / 6 / diff + 1 / 2;
            };

        if (diff == 0) {
            h = s = 0;
        } else {
            s = diff / v;
            rr = diffc(r);
            gg = diffc(g);
            bb = diffc(b);

            if (r === v) {
                h = bb - gg;
            } else if (g === v) {
                h = (1 / 3) + rr - bb;
            } else if (b === v) {
                h = (2 / 3) + gg - rr;
            }
            if (h < 0) {
                h += 1;
            } else if (h > 1) {
                h -= 1;
            }
        }
        return {
            h: Math.round(h * 360),
            s: Math.round(s * 100),
            v: Math.round(v * 100)
        };
    }
    </script>
</body>

</html>
